<script>
  (function() {
    function bindTabs(root){
      root.querySelectorAll('.product-tabs').forEach(function(group){
        var titles = group.querySelectorAll('.tab-titles li');
        var panels = group.querySelectorAll('.tab-content > div');
        titles.forEach(function(li){
          li.addEventListener('click', function(){
            titles.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            li.classList.add('active');
            var idx = li.dataset.tab;
            group.querySelector('#tab-panel-' + idx + '-{{ section.id }}')?.classList.add('active');
          });
          li.addEventListener('keydown', function(e){
            if (e.key === 'Enter' || e.key === ' ') li.click();
          });
        });
      });
    }
    document.addEventListener('DOMContentLoaded', function(){ bindTabs(document); });
    document.addEventListener('shopify:section:load', function(e){ bindTabs(e.target); });
    document.addEventListener('shopify:section:select', function(e){ bindTabs(e.target); });
  })();

  /*document.querySelectorAll('.tab-titles li').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.tab-titles li').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content > div').forEach(c => c.classList.remove('active'));

      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    });
  });*/
</script>

<style>
  .tab-content p {
      font-size: 1.4rem;
  }
</style>


<div class="product-tabs" {{ block.shopify_attributes }}>
  <ul class="tab-titles" role="tablist">
    {%- if block.settings.tab1_title != blank -%}
      <li role="tab" tabindex="0" aria-controls="tab-panel-1-{{ section.id }}"
          class="active" data-tab="1">{{ block.settings.tab1_title }}</li>
    {%- endif -%}
    {%- if block.settings.tab2_title != blank -%}
      <li role="tab" tabindex="-1" aria-controls="tab-panel-2-{{ section.id }}"
          data-tab="2">{{ block.settings.tab2_title }}</li>
    {%- endif -%}
    {%- if block.settings.tab3_title != blank -%}
      <li role="tab" tabindex="-1" aria-controls="tab-panel-3-{{ section.id }}"
          data-tab="3">{{ block.settings.tab3_title }}</li>
    {%- endif -%}
  </ul>

  {%- liquid
    # Prefer the full breadcrumb name if present
    assign _cat_key = product.category.full_name | default: product.category.name

    # Look up category defaults in metaobjects (create these in Admin → Content → Metaobjects)
    # care_guideline(metaobject): fields -> category_key (text), guidelines (rich text)
    assign _care_entry = shop.metaobjects.care_guideline.values | where: 'category_key', _cat_key | first

    # shipping_guideline(metaobject): fields -> category_key (text), policy (rich text)
    assign _ship_entry = shop.metaobjects.shipping_guideline.values | where: 'category_key', _cat_key | first

  -%}

  <script>
    console.log("Category: {{ product.category }}");
    console.log("Type: {{ product.type }}");
    console.log("Care guidelines handle: {{ _care_entry.system.handle }}");
    console.log("Care guidelines id: {{ _care_entry.system.id }}");
    console.log("Care guidelines type: {{ _care_entry.system.type }}");
    console.log("Care guidelines url: {{ _care_entry.system.url }}");
  </script>

  <div class="tab-content">
    {%- assign tab1_active = 'active' -%}
    {%- for i in (1..3) -%}
      {%- assign title_key = "tab" | append: i | append: "_title" -%}
      {%- assign title = block.settings[title_key] -%}
      {%- if title != blank -%}
        <div id="tab-panel-{{ i }}-{{ section.id }}" class="{{ tab1_active }}" role="tabpanel">
          {%- assign source_key = "tab" | append: i | append: "_source" -%}
          {%- assign source = block.settings[source_key] -%}
          {%- case source -%}
            {%- when 'description' -%}
              {{ product.description }}

            {%- when 'metafield_details' -%}
              {%- liquid
                assign _out = product.metafields.custom.details
                if _out == blank and _care_entry
                  assign _out = _care_entry.guidelines | metafield_tag
                endif
                if _out == blank
                  assign _out = block.settings.global_details_care_fallback
                endif
              -%}
              {{ _out }}

            {%- when 'metafield_shipping' -%}
              {%- liquid
                assign _out = product.metafields.custom.shipping
                if _out == blank and _ship_entry
                  assign _out = _ship_entry.policy | metafield_tag
                endif
                if _out == blank
                  assign _out = block.settings.global_ship_fallback
                endif
              -%}
              {{ _out }}

            {%- when 'richtext' -%}
              {%- assign block_key = "tab" | append: i | append: "_richtext" -%}
              {{ block.settings[block_key] }}

            {%- when 'page' -%}
              {%- assign pg_key = "tab" | append: i | append: "_page" -%}
              {%- assign pg = block.settings[pg_key] -%}
              {%- if pg and pg.content -%}{{ pg.content }}{%- endif -%}
          {%- endcase -%}

        </div>
        {%- assign tab1_active = '' -%}
      {%- endif -%}
    {%- endfor -%}
  </div>
</div>
